<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#020617">
    <title>Settings - SC Pressure Point</title>
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            primary: '#0ea5e9',
                            secondary: '#38bdf8',
                            dark: '#0f172a',
                            darker: '#020617',
                            accent: '#06b6d4',
                        }
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="data-migration.js"></script>
    <style>
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 0.5px solid rgba(255,255,255,0.05);
        }

        .setting-item:last-child { border-bottom: none; }
        .setting-item:active { background: rgba(255,255,255,0.03); }
        .toggle {
            width: 50px;
            height: 28px;
            background: #334155;
            border-radius: 14px;
            position: relative;
            transition: background 0.2s;
            cursor: pointer;
        }
        .toggle.on { background: #0ea5e9; }
        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .toggle.on::after { transform: translateX(22px); }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-header-inner">
            <a href="index.html" class="header-btn header-btn-left">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1>Settings</h1>
        </div>
    </header>

    <main class="app-content">
        <div class="content-wrapper">
            <!-- Business Info -->
            <p class="section-title mb-2 px-1">Business Info</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5">
                    <label class="text-xs text-gray-400">Business Name</label>
                    <input type="text" id="businessName" value="SC Pressure Point" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
                <div class="setting-item p-4 border-b border-white/5">
                    <label class="text-xs text-gray-400">Phone Number</label>
                    <input type="tel" id="businessPhone" value="803-272-8118" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
                <div class="setting-item p-4">
                    <label class="text-xs text-gray-400">Email</label>
                    <input type="email" id="businessEmail" value="scpressurepoint@gmail.com" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
            </div>

            <!-- Default Pricing -->
            <p class="section-title mb-2 px-1">Default Pricing ($/sqft)</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>Driveway</span>
                    <input type="number" id="priceDriveway" value="0.15" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>House Wash</span>
                    <input type="number" id="priceHouse" value="0.25" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>Deck/Patio</span>
                    <input type="number" id="priceDeck" value="0.30" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 flex justify-between items-center">
                    <span>Minimum Job</span>
                    <input type="number" id="priceMin" value="75" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
            </div>

            <!-- Preferences -->
            <p class="section-title mb-2 px-1">Preferences</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <div>
                        <p>Default Job Duration</p>
                        <p class="text-xs text-gray-400">Hours per job</p>
                    </div>
                    <select id="defaultDuration" class="bg-slate-700 rounded-lg p-2 text-sm">
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours</option>
                        <option value="2" selected>2 hours</option>
                        <option value="3">3 hours</option>
                        <option value="4">4 hours</option>
                    </select>
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <div>
                        <p>Calendar View</p>
                        <p class="text-xs text-gray-400">Default calendar display</p>
                    </div>
                    <select id="calendarView" class="bg-slate-700 rounded-lg p-2 text-sm">
                        <option value="month" selected>Month</option>
                        <option value="week">Week</option>
                        <option value="day">Day</option>
                    </select>
                </div>
                <div class="setting-item p-4 flex justify-between items-center">
                    <div>
                        <p>Job Reminders</p>
                        <p class="text-xs text-gray-400">Calendar event reminders</p>
                    </div>
                    <div id="toggleReminders" class="toggle on" onclick="toggleSetting('reminders')"></div>
                </div>
            </div>

            <!-- Google Calendar -->
            <p class="section-title mb-2 px-1">Google Calendar</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 flex justify-between items-center">
                    <div>
                        <p>Connection Status</p>
                        <p class="text-xs text-gray-400" id="gcalStatus">Not connected</p>
                    </div>
                    <button onclick="manageGoogleConnection()" id="gcalBtn" class="bg-white text-gray-800 px-4 py-2 rounded-xl text-sm font-semibold">
                        Connect
                    </button>
                </div>
            </div>
            <!-- Cloud Sync -->
            <p class="section-title mb-2 px-1">Cloud Sync</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="p-4 border-b border-white/5">
                    <p style="font-size: 12px; color: #94a3b8;">Sync customers, jobs, and settings across devices.</p>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="text-xs text-gray-400">Sync Key (same on all devices)</label>
                        <input type="text" id="syncKey" placeholder="e.g. scpressurepoint" class="w-full bg-slate-700 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Firebase API Key</label>
                        <input type="text" id="syncApiKey" placeholder="AIza..." class="w-full bg-slate-700 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Firebase Project ID</label>
                        <input type="text" id="syncProjectId" placeholder="your-project-id" class="w-full bg-slate-700 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Firebase Database URL</label>
                        <input type="text" id="syncDbUrl" placeholder="https://your-project-id.firebaseio.com" class="w-full bg-slate-700 rounded-lg p-2 text-sm">
                    </div>
                    <div class="flex items-center justify-between pt-2">
                        <span class="text-sm">Enable Cloud Sync</span>
                        <div id="toggleCloudSync" class="toggle" onclick="toggleCloudSync()"></div>
                    </div>
                    <button onclick="syncNow()" class="w-full bg-primary text-white py-2 rounded-xl text-sm font-semibold">
                        Sync Now
                    </button>
                    <p class="text-xs text-gray-500">Firebase rules should allow authenticated users: <code>.read/.write: auth != null</code></p>
                </div>
            </div>
            <!-- Sync Diagnostics -->
            <p class="section-title mb-2 px-1">Sync Diagnostics</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="p-4 space-y-2 text-xs text-gray-400">
                    <div>Status: <span id="syncStatusText">-</span></div>
                    <div>Last Push: <span id="syncLastPush">-</span></div>
                    <div>Last Pull: <span id="syncLastPull">-</span></div>
                    <div>Auth UID: <span id="syncAuthUid">-</span></div>
                    <div>Auth Token (last 8): <span id="syncAuthTokenTail">-</span></div>
                    <div>Client ID: <span id="syncClientId">-</span></div>
                    <div>Last Error: <span id="syncLastError">-</span></div>
                </div>
                <div class="p-4 border-t border-white/5 flex gap-2">
                    <button onclick="runSyncTest()" class="flex-1 bg-slate-700 text-white py-2 rounded-xl text-sm font-semibold">
                        Test Connection
                    </button>
                    <button onclick="toggleSyncLog()" class="flex-1 bg-slate-800 text-white py-2 rounded-xl text-sm font-semibold">
                        View Log
                    </button>
                </div>
                <div id="syncLogPanel" class="hidden p-4 border-t border-white/5">
                    <pre id="syncLogText" class="text-[11px] text-gray-300 whitespace-pre-wrap"></pre>
                    <button onclick="clearSyncLog()" class="mt-2 w-full bg-slate-700 text-white py-2 rounded-xl text-sm font-semibold">
                        Clear Log
                    </button>
                </div>
            </div>

            <!-- Data Management -->
            <p class="section-title mb-2 px-1">Data</p>
            <p style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; padding-left: 4px;">To move data between devices: Export on one device, then Import on the other.</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <button onclick="exportData()" class="setting-item p-4 border-b border-white/5 w-full text-left flex justify-between items-center">
                    <div>
                        <p>Export Data</p>
                        <p class="text-xs text-gray-400">Download all customer data</p>
                    </div>
                    <i class="fas fa-download text-primary"></i>
                </button>
                <button onclick="importData()" class="setting-item p-4 border-b border-white/5 w-full text-left flex justify-between items-center">
                    <div>
                        <p>Import Data</p>
                        <p class="text-xs text-gray-400">Restore from backup</p>
                    </div>
                    <i class="fas fa-upload text-primary"></i>
                </button>
                <button onclick="confirmClearData()" class="setting-item p-4 w-full text-left flex justify-between items-center">
                    <div>
                        <p class="text-red-400">Clear All Data</p>
                        <p class="text-xs text-gray-400">Delete all customers & jobs</p>
                    </div>
                    <i class="fas fa-trash text-red-400"></i>
                </button>
            </div>

            <!-- App Info -->
            <p class="section-title mb-2 px-1">About</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="p-4 text-center">
                    <img src="../assets/images/Logo.png" class="w-16 h-16 mx-auto mb-2 rounded-2xl">
                    <p class="font-semibold">SC Pressure Point</p>
                    <p class="text-xs text-gray-400">Business Tools v1.0</p>
                    <p class="text-xs text-gray-500 mt-2">Â© 2024 SC Pressure Point LLC</p>
                </div>
            </div>

            <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(this)">
        </div>
    </main>

    <script>
        // Load saved settings
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('ppw-settings') || '{}');
            
            if (settings.businessName) document.getElementById('businessName').value = settings.businessName;
            if (settings.businessPhone) document.getElementById('businessPhone').value = settings.businessPhone;
            if (settings.businessEmail) document.getElementById('businessEmail').value = settings.businessEmail;
            if (settings.priceDriveway) document.getElementById('priceDriveway').value = settings.priceDriveway;
            if (settings.priceHouse) document.getElementById('priceHouse').value = settings.priceHouse;
            if (settings.priceDeck) document.getElementById('priceDeck').value = settings.priceDeck;
            if (settings.priceMin) document.getElementById('priceMin').value = settings.priceMin;
            if (settings.defaultDuration) document.getElementById('defaultDuration').value = settings.defaultDuration;
            if (settings.calendarView) document.getElementById('calendarView').value = settings.calendarView;
            if (settings.reminders === false) document.getElementById('toggleReminders').classList.remove('on');

            // Check Google Calendar connection
            const token = localStorage.getItem('gcal-token');
            const expiry = localStorage.getItem('gcal-token-expiry');
            if (token && expiry > Date.now()) {
                document.getElementById('gcalStatus').textContent = 'Connected';
                document.getElementById('gcalBtn').textContent = 'Disconnect';
                document.getElementById('gcalBtn').classList.remove('bg-white', 'text-gray-800');
                document.getElementById('gcalBtn').classList.add('bg-red-600', 'text-white');
            }

            // Auto-save on change
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', saveSettings);
            });
            
            // Load cloud sync config (pre-fill with defaults if empty)
            const defaultSyncConfig = {
                syncKey: 'scpressurepoint',
                apiKey: 'AIzaSyDtiQgexvwyBni2uakvbFnX7ZWS11ribSs',
                projectId: 'scpressurepoint-245d4',
                databaseURL: 'https://scpressurepoint-245d4-default-rtdb.firebaseio.com/'
            };
            const syncConfig = PPW_DATA.getSyncConfig() || {};
            const mergedSyncConfig = { ...defaultSyncConfig, ...syncConfig };
            document.getElementById('syncKey').value = mergedSyncConfig.syncKey || '';
            document.getElementById('syncApiKey').value = mergedSyncConfig.apiKey || '';
            document.getElementById('syncProjectId').value = mergedSyncConfig.projectId || '';
            document.getElementById('syncDbUrl').value = mergedSyncConfig.databaseURL || '';
            if (PPW_DATA.isSyncEnabled()) {
                document.getElementById('toggleCloudSync').classList.add('on');
            }

            // Auto-save sync config on input
            ['syncKey', 'syncApiKey', 'syncProjectId', 'syncDbUrl'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', saveSyncConfig);
            });

            refreshSyncDiagnostics();
        });

        function saveSettings() {
            const settings = {
                businessName: document.getElementById('businessName').value,
                businessPhone: document.getElementById('businessPhone').value,
                businessEmail: document.getElementById('businessEmail').value,
                priceDriveway: document.getElementById('priceDriveway').value,
                priceHouse: document.getElementById('priceHouse').value,
                priceDeck: document.getElementById('priceDeck').value,
                priceMin: document.getElementById('priceMin').value,
                defaultDuration: document.getElementById('defaultDuration').value,
                calendarView: document.getElementById('calendarView').value,
                reminders: document.getElementById('toggleReminders').classList.contains('on')
            };
            localStorage.setItem('ppw-settings', JSON.stringify(settings));
        }
        
        function saveSyncConfig() {
            const config = {
                syncKey: document.getElementById('syncKey').value.trim(),
                apiKey: document.getElementById('syncApiKey').value.trim(),
                projectId: document.getElementById('syncProjectId').value.trim(),
                databaseURL: document.getElementById('syncDbUrl').value.trim()
            };
            PPW_DATA.setSyncConfig(config);
            return config;
        }

        function isSyncConfigValid(config) {
            return !!(config.syncKey && config.apiKey && config.projectId && config.databaseURL);
        }
        
        function toggleCloudSync() {
            const toggle = document.getElementById('toggleCloudSync');
            toggle.classList.toggle('on');
            const config = saveSyncConfig();
            if (toggle.classList.contains('on')) {
                if (!isSyncConfigValid(config)) {
                    alert('Please fill in Sync Key, API Key, Project ID, and Database URL first.');
                    toggle.classList.remove('on');
                    PPW_DATA.disableSync();
                    return;
                }
                PPW_DATA.enableSync();
            } else {
                PPW_DATA.disableSync();
            }
            refreshSyncDiagnostics();
        }
        
        async function syncNow() {
            const config = saveSyncConfig();
            if (!isSyncConfigValid(config)) {
                alert('Please fill in Sync Key, API Key, Project ID, and Database URL first.');
                return;
            }
            await PPW_DATA.enableSync();
            await PPW_DATA.syncNow();
            alert('Cloud sync complete');
            refreshSyncDiagnostics();
        }

        function formatTs(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        function refreshSyncDiagnostics() {
            if (!PPW_DATA.getSyncStatus) return;
            const status = PPW_DATA.getSyncStatus() || {};
            document.getElementById('syncStatusText').textContent = status.status || (PPW_DATA.isSyncEnabled() ? 'enabled' : 'disabled');
            document.getElementById('syncLastPush').textContent = formatTs(status.lastPushAt);
            document.getElementById('syncLastPull').textContent = formatTs(status.lastPullAt);
            document.getElementById('syncAuthUid').textContent = status.authUid || '-';
            document.getElementById('syncAuthTokenTail').textContent = status.authTokenTail || '-';
            document.getElementById('syncClientId').textContent = status.clientId || PPW_DATA.getClientId();
            document.getElementById('syncLastError').textContent = status.lastError || '-';
        }

        function toggleSyncLog() {
            const panel = document.getElementById('syncLogPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderSyncLog();
            }
        }

        function renderSyncLog() {
            const log = PPW_DATA.getSyncLog ? PPW_DATA.getSyncLog() : [];
            if (!log.length) {
                document.getElementById('syncLogText').textContent = 'No log entries yet.';
                return;
            }
            const lines = log.map(entry => {
                const time = formatTs(entry.ts);
                return `[${time}] ${entry.event} ${entry.details || ''}`.trim();
            });
            document.getElementById('syncLogText').textContent = lines.join('\\n');
        }

        function clearSyncLog() {
            if (PPW_DATA.clearSyncLog) PPW_DATA.clearSyncLog();
            renderSyncLog();
        }

        async function runSyncTest() {
            const config = saveSyncConfig();
            if (!isSyncConfigValid(config)) {
                alert('Please fill in Sync Key, API Key, Project ID, and Database URL first.');
                return;
            }
            const result = await PPW_DATA.testCloudSync();
            refreshSyncDiagnostics();
            if (result && result.ok) {
                alert('Sync test OK (write + read).');
            } else {
                alert('Sync test failed: ' + (result?.error || 'unknown error'));
            }
        }

        function toggleSetting(setting) {
            const toggle = document.getElementById('toggle' + setting.charAt(0).toUpperCase() + setting.slice(1));
            toggle.classList.toggle('on');
            saveSettings();
        }

        function manageGoogleConnection() {
            const token = localStorage.getItem('gcal-token');
            if (token) {
                // Disconnect
                localStorage.removeItem('gcal-token');
                localStorage.removeItem('gcal-token-expiry');
                document.getElementById('gcalStatus').textContent = 'Not connected';
                document.getElementById('gcalBtn').textContent = 'Connect';
                document.getElementById('gcalBtn').classList.add('bg-white', 'text-gray-800');
                document.getElementById('gcalBtn').classList.remove('bg-red-600', 'text-white');
            } else {
                // Redirect to quick-add to connect
                window.location.href = 'quick-add.html';
            }
        }

        function exportData() {
            const data = PPW_DATA.exportAll();
            data.settings = JSON.parse(localStorage.getItem('ppw-settings') || '{}');
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sc-pressure-point-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Use PPW_DATA to import (handles both old and new format)
                    PPW_DATA.importData(data);
                    
                    if (data.settings) {
                        localStorage.setItem('ppw-settings', JSON.stringify(data.settings));
                    }
                    
                    alert('Data imported successfully! Reloading...');
                    location.reload();
                } catch (err) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        function confirmClearData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                if (confirm('This will delete all customers, jobs, and settings. Are you REALLY sure?')) {
                    PPW_DATA.clearAll();
                    localStorage.removeItem('ppw-settings');
                    localStorage.removeItem('ppw-checklist');
                    alert('All data cleared.');
                    location.reload();
                }
            }
        }
    </script>

    <!-- Bottom Tab Bar -->
    <nav class="tab-bar">
        <div class="tab-bar-inner">
            <a href="index.html" class="tab-item">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="jobs.html" class="tab-item">
                <i class="fas fa-briefcase"></i>
                <span>Jobs</span>
            </a>
            <a href="quick-add.html" class="tab-item tab-item-add">
                <div class="tab-add-btn">
                    <i class="fas fa-plus"></i>
                </div>
                <span>Add</span>
            </a>
            <a href="calendar.html" class="tab-item">
                <i class="fas fa-calendar"></i>
                <span>Calendar</span>
            </a>
            <a href="customer-tracker.html" class="tab-item">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
        </div>
    </nav>
</body>
</html>
