<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#020617">
    <title>Settings - SC Pressure Point</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="data-migration.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        dark: '#0f172a',
                        darker: '#020617',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { 
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
            color: #f8fafc;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }
        .app-header {
            padding-top: var(--safe-top);
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        .app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: var(--safe-bottom);
        }
        .app-content::-webkit-scrollbar { width: 0; }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 0.5px solid rgba(255,255,255,0.08);
        }
        .setting-item {
            transition: all 0.12s ease;
        }
        .setting-item:active {
            background: rgba(255,255,255,0.05);
        }
        .toggle {
            width: 50px;
            height: 28px;
            background: #334155;
            border-radius: 14px;
            position: relative;
            transition: background 0.2s;
            cursor: pointer;
        }
        .toggle.on {
            background: #0ea5e9;
        }
        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .toggle.on::after {
            transform: translateX(22px);
        }
        .section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: #64748b;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="flex items-center justify-between max-w-lg mx-auto px-4 py-3">
            <a href="index.html" class="text-primary p-2 -ml-2 rounded-xl">
                <i class="fas fa-chevron-left text-lg"></i>
            </a>
            <h1 class="text-lg font-semibold">Settings</h1>
            <div class="w-8"></div>
        </div>
    </header>

    <main class="app-content">
        <div class="max-w-lg mx-auto px-4 py-4">
            <!-- Business Info -->
            <p class="section-title mb-2 px-1">Business Info</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5">
                    <label class="text-xs text-gray-400">Business Name</label>
                    <input type="text" id="businessName" value="SC Pressure Point" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
                <div class="setting-item p-4 border-b border-white/5">
                    <label class="text-xs text-gray-400">Phone Number</label>
                    <input type="tel" id="businessPhone" value="803-272-8118" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
                <div class="setting-item p-4">
                    <label class="text-xs text-gray-400">Email</label>
                    <input type="email" id="businessEmail" value="scpressurepoint@gmail.com" class="w-full bg-transparent text-white mt-1 outline-none">
                </div>
            </div>

            <!-- Default Pricing -->
            <p class="section-title mb-2 px-1">Default Pricing ($/sqft)</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>Driveway</span>
                    <input type="number" id="priceDriveway" value="0.15" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>House Wash</span>
                    <input type="number" id="priceHouse" value="0.25" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <span>Deck/Patio</span>
                    <input type="number" id="priceDeck" value="0.30" step="0.01" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
                <div class="setting-item p-4 flex justify-between items-center">
                    <span>Minimum Job</span>
                    <input type="number" id="priceMin" value="75" class="w-20 bg-slate-700 rounded-lg p-2 text-right text-sm">
                </div>
            </div>

            <!-- Preferences -->
            <p class="section-title mb-2 px-1">Preferences</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <div>
                        <p>Default Job Duration</p>
                        <p class="text-xs text-gray-400">Hours per job</p>
                    </div>
                    <select id="defaultDuration" class="bg-slate-700 rounded-lg p-2 text-sm">
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours</option>
                        <option value="2" selected>2 hours</option>
                        <option value="3">3 hours</option>
                        <option value="4">4 hours</option>
                    </select>
                </div>
                <div class="setting-item p-4 border-b border-white/5 flex justify-between items-center">
                    <div>
                        <p>Calendar View</p>
                        <p class="text-xs text-gray-400">Default calendar display</p>
                    </div>
                    <select id="calendarView" class="bg-slate-700 rounded-lg p-2 text-sm">
                        <option value="month" selected>Month</option>
                        <option value="week">Week</option>
                        <option value="day">Day</option>
                    </select>
                </div>
                <div class="setting-item p-4 flex justify-between items-center">
                    <div>
                        <p>Job Reminders</p>
                        <p class="text-xs text-gray-400">Calendar event reminders</p>
                    </div>
                    <div id="toggleReminders" class="toggle on" onclick="toggleSetting('reminders')"></div>
                </div>
            </div>

            <!-- Google Calendar -->
            <p class="section-title mb-2 px-1">Google Calendar</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="setting-item p-4 flex justify-between items-center">
                    <div>
                        <p>Connection Status</p>
                        <p class="text-xs text-gray-400" id="gcalStatus">Not connected</p>
                    </div>
                    <button onclick="manageGoogleConnection()" id="gcalBtn" class="bg-white text-gray-800 px-4 py-2 rounded-xl text-sm font-semibold">
                        Connect
                    </button>
                </div>
            </div>

            <!-- Sync Between Devices -->
            <p class="section-title mb-2 px-1">Sync Between Devices</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4" id="syncSection">
                <div class="p-4 border-b border-white/5">
                    <p class="text-sm mb-2">Sync your data to another device (phone ↔ laptop)</p>
                    <button onclick="generateSyncLink()" class="w-full bg-primary text-white py-3 rounded-xl font-semibold text-sm">
                        <i class="fas fa-share-alt mr-2"></i>Generate Sync Link
                    </button>
                </div>
                <div id="syncLinkBox" class="hidden p-4 border-b border-white/5 bg-slate-800/50">
                    <p class="text-xs text-gray-400 mb-2">Share this link or scan QR on your other device:</p>
                    <div class="flex gap-2 mb-3">
                        <button onclick="copySyncLink()" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-semibold">
                            <i class="fas fa-copy mr-1"></i>Copy Link
                        </button>
                        <button onclick="shareSyncLink()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold">
                            <i class="fas fa-share mr-1"></i>Share
                        </button>
                    </div>
                    <div id="qrCode" class="flex justify-center"></div>
                </div>
                <div class="p-4">
                    <p class="text-xs text-gray-400 mb-2">Last synced: <span id="lastSyncTime">Never</span></p>
                </div>
            </div>

            <!-- Data Management -->
            <p class="section-title mb-2 px-1">Data</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <button onclick="exportData()" class="setting-item p-4 border-b border-white/5 w-full text-left flex justify-between items-center">
                    <div>
                        <p>Export Data</p>
                        <p class="text-xs text-gray-400">Download all customer data</p>
                    </div>
                    <i class="fas fa-download text-primary"></i>
                </button>
                <button onclick="importData()" class="setting-item p-4 border-b border-white/5 w-full text-left flex justify-between items-center">
                    <div>
                        <p>Import Data</p>
                        <p class="text-xs text-gray-400">Restore from backup</p>
                    </div>
                    <i class="fas fa-upload text-primary"></i>
                </button>
                <button onclick="confirmClearData()" class="setting-item p-4 w-full text-left flex justify-between items-center">
                    <div>
                        <p class="text-red-400">Clear All Data</p>
                        <p class="text-xs text-gray-400">Delete all customers & jobs</p>
                    </div>
                    <i class="fas fa-trash text-red-400"></i>
                </button>
            </div>

            <!-- App Info -->
            <p class="section-title mb-2 px-1">About</p>
            <div class="glass-card rounded-2xl overflow-hidden mb-4">
                <div class="p-4 text-center">
                    <img src="../assets/images/Logo.png" class="w-16 h-16 mx-auto mb-2 rounded-2xl">
                    <p class="font-semibold">SC Pressure Point</p>
                    <p class="text-xs text-gray-400">Business Tools v1.0</p>
                    <p class="text-xs text-gray-500 mt-2">© 2024 SC Pressure Point LLC</p>
                </div>
            </div>

            <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(this)">
        </div>
    </main>

    <script>
        // Load saved settings
        document.addEventListener('DOMContentLoaded', () => {
            const settings = JSON.parse(localStorage.getItem('ppw-settings') || '{}');
            
            if (settings.businessName) document.getElementById('businessName').value = settings.businessName;
            if (settings.businessPhone) document.getElementById('businessPhone').value = settings.businessPhone;
            if (settings.businessEmail) document.getElementById('businessEmail').value = settings.businessEmail;
            if (settings.priceDriveway) document.getElementById('priceDriveway').value = settings.priceDriveway;
            if (settings.priceHouse) document.getElementById('priceHouse').value = settings.priceHouse;
            if (settings.priceDeck) document.getElementById('priceDeck').value = settings.priceDeck;
            if (settings.priceMin) document.getElementById('priceMin').value = settings.priceMin;
            if (settings.defaultDuration) document.getElementById('defaultDuration').value = settings.defaultDuration;
            if (settings.calendarView) document.getElementById('calendarView').value = settings.calendarView;
            if (settings.reminders === false) document.getElementById('toggleReminders').classList.remove('on');

            // Check Google Calendar connection
            const token = localStorage.getItem('gcal-token');
            const expiry = localStorage.getItem('gcal-token-expiry');
            if (token && expiry > Date.now()) {
                document.getElementById('gcalStatus').textContent = 'Connected';
                document.getElementById('gcalBtn').textContent = 'Disconnect';
                document.getElementById('gcalBtn').classList.remove('bg-white', 'text-gray-800');
                document.getElementById('gcalBtn').classList.add('bg-red-600', 'text-white');
            }

            // Auto-save on change
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', saveSettings);
            });
        });

        function saveSettings() {
            const settings = {
                businessName: document.getElementById('businessName').value,
                businessPhone: document.getElementById('businessPhone').value,
                businessEmail: document.getElementById('businessEmail').value,
                priceDriveway: document.getElementById('priceDriveway').value,
                priceHouse: document.getElementById('priceHouse').value,
                priceDeck: document.getElementById('priceDeck').value,
                priceMin: document.getElementById('priceMin').value,
                defaultDuration: document.getElementById('defaultDuration').value,
                calendarView: document.getElementById('calendarView').value,
                reminders: document.getElementById('toggleReminders').classList.contains('on')
            };
            localStorage.setItem('ppw-settings', JSON.stringify(settings));
        }

        function toggleSetting(setting) {
            const toggle = document.getElementById('toggle' + setting.charAt(0).toUpperCase() + setting.slice(1));
            toggle.classList.toggle('on');
            saveSettings();
        }

        function manageGoogleConnection() {
            const token = localStorage.getItem('gcal-token');
            if (token) {
                // Disconnect
                localStorage.removeItem('gcal-token');
                localStorage.removeItem('gcal-token-expiry');
                document.getElementById('gcalStatus').textContent = 'Not connected';
                document.getElementById('gcalBtn').textContent = 'Connect';
                document.getElementById('gcalBtn').classList.add('bg-white', 'text-gray-800');
                document.getElementById('gcalBtn').classList.remove('bg-red-600', 'text-white');
            } else {
                // Redirect to quick-add to connect
                window.location.href = 'quick-add.html';
            }
        }

        function exportData() {
            const data = PPW_DATA.exportAll();
            data.settings = JSON.parse(localStorage.getItem('ppw-settings') || '{}');
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sc-pressure-point-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Use PPW_DATA to import (handles both old and new format)
                    PPW_DATA.importData(data);
                    
                    if (data.settings) {
                        localStorage.setItem('ppw-settings', JSON.stringify(data.settings));
                    }
                    
                    alert('Data imported successfully! Reloading...');
                    location.reload();
                } catch (err) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        function confirmClearData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                if (confirm('This will delete all customers, jobs, and settings. Are you REALLY sure?')) {
                    PPW_DATA.clearAll();
                    localStorage.removeItem('ppw-settings');
                    localStorage.removeItem('ppw-checklist');
                    alert('All data cleared.');
                    location.reload();
                }
            }
        }

        // Sync functions
        let currentSyncURL = '';

        function generateSyncLink() {
            currentSyncURL = PPW_DATA.generateSyncURL();
            document.getElementById('syncLinkBox').classList.remove('hidden');
            
            // Generate QR code using QR Server API
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(currentSyncURL)}" alt="QR Code" class="rounded-lg">`;
        }

        function copySyncLink() {
            navigator.clipboard.writeText(currentSyncURL).then(() => {
                alert('Link copied! Open this on your other device.');
            });
        }

        function shareSyncLink() {
            if (navigator.share) {
                navigator.share({
                    title: 'SC Pressure Point Data Sync',
                    text: 'Import my business data',
                    url: currentSyncURL
                });
            } else {
                copySyncLink();
            }
        }

        // Check for incoming sync data on page load
        function checkForSyncData() {
            const syncData = PPW_DATA.importFromURL();
            if (syncData) {
                const customerCount = syncData.customers?.length || 0;
                const jobCount = syncData.jobs?.length || 0;
                
                if (confirm(`Import ${customerCount} customers and ${jobCount} jobs from another device?\n\nThis will REPLACE your current data.`)) {
                    PPW_DATA.importData(syncData);
                    PPW_DATA.setLastSync();
                    
                    if (syncData.settings) {
                        localStorage.setItem('ppw-settings', JSON.stringify(syncData.settings));
                    }
                    
                    // Clear URL params and reload
                    window.history.replaceState({}, '', window.location.pathname);
                    alert('Data synced successfully!');
                    location.reload();
                } else {
                    // Clear the sync param from URL
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
            
            // Update last sync time display
            const lastSync = PPW_DATA.getLastSync();
            if (lastSync) {
                const date = new Date(lastSync);
                document.getElementById('lastSyncTime').textContent = date.toLocaleString();
            }
        }

        // Run sync check on load
        document.addEventListener('DOMContentLoaded', checkForSyncData);
    </script>
</body>
</html>
