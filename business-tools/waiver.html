<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020617">
    <title>Service Waiver - SC Pressure Point</title>
    <script src="utils.js"></script>
    <link rel="manifest" href="manifest.json">
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            primary: '#0ea5e9',
                            secondary: '#38bdf8',
                            dark: '#0f172a',
                            darker: '#020617',
                            accent: '#06b6d4',
                        }
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="data-migration.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: white;
            color: black;
            padding: 0;
            line-height: 1.4;
        }
        
        .main-content {
            padding: 16px 20px 90px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .input-section {
            border: 1px solid black;
            padding: 20px;
        }
        
        .input-section h2 {
            border-bottom: 2px solid black;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid black;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            height: 60px;
        }
        
        .signature-container {
            border: 2px solid black;
            background: #f9f9f9;
            margin-bottom: 15px;
        }
        
        .signature-canvas {
            width: 100%;
            height: 120px;
            cursor: crosshair;
            touch-action: none;
            display: block;
        }
        
        .signature-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #eee;
            border-bottom: 1px solid black;
        }
        
        .clear-sig-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .calc-button {
            width: 100%;
            background: black;
            color: white;
            border: none;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .calc-button:hover {
            background: #333;
        }
        
        .save-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .save-btn:hover {
            background: #059669;
        }
        
        .results-section {
            border: 1px solid black;
            min-height: 500px;
        }
        
        .waiver-content {
            padding: 30px;
            font-size: 12px;
        }
        
        .waiver-header {
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .waiver-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .waiver-header h2 {
            font-size: 16px;
            font-weight: normal;
        }
        
        .waiver-parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .waiver-party h3 {
            font-size: 12px;
            border-bottom: 1px solid black;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        
        .waiver-party p {
            margin: 3px 0;
            font-size: 12px;
        }
        
        .waiver-text {
            margin-bottom: 20px;
        }
        
        .waiver-text h3 {
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        
        .waiver-text p {
            margin-bottom: 10px;
            text-align: justify;
            font-size: 11px;
            line-height: 1.5;
        }
        
        .waiver-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .waiver-text li {
            margin-bottom: 5px;
            font-size: 11px;
        }
        
        .signature-display {
            margin-top: 30px;
            border-top: 2px solid black;
            padding-top: 20px;
        }
        
        .signature-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .signature-line {
            border-bottom: 1px solid black;
            min-height: 50px;
            position: relative;
        }
        
        .signature-line img {
            max-height: 45px;
            position: absolute;
            bottom: 5px;
        }
        
        .signature-line span {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }
        
        .date-line {
            border-bottom: 1px solid black;
            padding-bottom: 5px;
            font-size: 14px;
        }
        
        .date-line span {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }
        
        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .share-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .share-btn.download {
            background: black;
            color: white;
        }
        
        .share-btn:hover {
            opacity: 0.9;
        }
        
        @media (max-width: 800px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            .tab-bar, nav.tab-bar, .app-header, header {
                display: none !important;
            }
            .input-section, .share-buttons, button:not(.print-include) {
                display: none !important;
            }
            .results-section {
                display: block !important;
                border: none !important;
                width: 100% !important;
            }
            body {
                background: #fff !important;
                padding: 0 !important;
            }
            .container {
                grid-template-columns: 1fr !important;
            }
            .waiver-content {
                padding: 10mm !important;
            }
            @page {
                size: letter portrait;
                margin: 10mm;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-header-inner">
            <a href="jobs.html" class="header-btn header-btn-left">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1>Service Waiver</h1>
        </div>
    </header>
    
    <main class="app-content">
        <div class="main-content">
            <div class="container">
                <div class="input-section">
                    <h2>LIABILITY WAIVER FORM</h2>
                    
                    <form id="waiverForm">
                        <div class="form-group">
                            <label for="customerName">Customer Name:</label>
                            <input type="text" id="customerName" placeholder="Full legal name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customerAddress">Property Address:</label>
                            <textarea id="customerAddress" placeholder="Service address"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="customerPhone">Phone Number:</label>
                            <input type="tel" id="customerPhone" placeholder="Contact number">
                        </div>
                        
                        <div class="form-group">
                            <label for="serviceDescription">Service Description:</label>
                            <textarea id="serviceDescription" placeholder="Describe services to be performed"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="waiverDate">Date:</label>
                            <input type="date" id="waiverDate" required>
                        </div>
                        
                        <div class="signature-container">
                            <div class="signature-label">
                                <span><strong>Customer Signature</strong></span>
                                <button type="button" class="clear-sig-btn" onclick="clearSignature()">Clear</button>
                            </div>
                            <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                        </div>
                        
                        <button type="button" class="calc-button" onclick="generateWaiver()">
                            <i class="fas fa-file-signature" style="margin-right: 8px;"></i>Generate Waiver
                        </button>
                        
                        <button type="button" class="save-btn" onclick="saveToJob()" id="saveBtn" style="display: none;">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>Save to Job
                        </button>
                    </form>
                </div>
                
                <div class="results-section">
                    <div id="waiverPreview" class="waiver-content">
                        <div style="text-align: center; color: #666; padding: 50px;">
                            <i class="fas fa-file-signature" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Fill out the form and generate the waiver to see the preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="tab-bar">
        <div class="tab-bar-inner">
            <a href="index.html" class="tab-item">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="jobs.html" class="tab-item">
                <i class="fas fa-briefcase"></i>
                <span>Jobs</span>
            </a>
            <a href="quick-add.html" class="tab-item tab-item-add">
                <div class="tab-add-btn">
                    <i class="fas fa-plus"></i>
                </div>
                <span>Add</span>
            </a>
            <a href="calendar.html" class="tab-item">
                <i class="fas fa-calendar"></i>
                <span>Calendar</span>
            </a>
            <a href="customer-tracker.html" class="tab-item">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
        </div>
    </nav>

    <script>
        // Get job ID from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');
        let currentJob = null;
        
        // Signature canvas setup
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                y: (touch.clientY - rect.top) * (canvas.height / rect.height)
            };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
        
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function getSignatureImage() {
            // Check if canvas has content
            const pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const hasContent = pixelData.some((val, i) => i % 4 === 3 && val > 0);
            return hasContent ? canvas.toDataURL('image/png') : null;
        }
        
        function getBusinessInfo() {
            const settings = JSON.parse(localStorage.getItem('ppw-settings') || '{}');
            return {
                name: settings.businessName || 'SC Pressure Point',
                phone: settings.businessPhone || '',
                email: settings.businessEmail || ''
            };
        }
        
        function generateWaiver() {
            const business = getBusinessInfo();
            const customerName = document.getElementById('customerName').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const serviceDescription = document.getElementById('serviceDescription').value.trim();
            const waiverDate = document.getElementById('waiverDate').value;
            const signatureImg = getSignatureImage();
            
            if (!customerName) {
                alert('Please enter customer name');
                return;
            }
            
            if (!signatureImg) {
                alert('Please provide a signature');
                return;
            }
            
            const formattedDate = waiverDate ? new Date(waiverDate + 'T12:00:00').toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            }) : new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            document.getElementById('waiverPreview').innerHTML = `
                <div class="waiver-header">
                    <h1>${business.name}</h1>
                    <h2>SERVICE LIABILITY WAIVER</h2>
                </div>
                
                <div class="waiver-parties">
                    <div class="waiver-party">
                        <h3>SERVICE PROVIDER</h3>
                        <p><strong>${business.name}</strong></p>
                        ${business.phone ? `<p>Phone: ${business.phone}</p>` : ''}
                        ${business.email ? `<p>Email: ${business.email}</p>` : ''}
                    </div>
                    <div class="waiver-party">
                        <h3>CUSTOMER</h3>
                        <p><strong>${customerName}</strong></p>
                        ${customerAddress ? `<p>${customerAddress.replace(/\n/g, '<br>')}</p>` : ''}
                        ${customerPhone ? `<p>Phone: ${customerPhone}</p>` : ''}
                    </div>
                </div>
                
                ${serviceDescription ? `
                <div class="waiver-text">
                    <h3>SERVICE DESCRIPTION</h3>
                    <p>${serviceDescription}</p>
                </div>
                ` : ''}
                
                <div class="waiver-text">
                    <h3>TERMS AND CONDITIONS</h3>
                    <p>By signing this waiver, the Customer acknowledges and agrees to the following:</p>
                    <ul>
                        <li><strong>Assumption of Risk:</strong> Customer understands that pressure washing and related services involve inherent risks including but not limited to potential water damage, surface damage, and property damage.</li>
                        <li><strong>Pre-existing Conditions:</strong> Customer acknowledges that the Service Provider is not responsible for any pre-existing damage, deterioration, loose paint, unstable surfaces, or conditions that may be revealed or affected by the cleaning process.</li>
                        <li><strong>Property Access:</strong> Customer grants permission for the Service Provider to access the property and perform the agreed-upon services.</li>
                        <li><strong>Liability Waiver:</strong> Customer releases and holds harmless the Service Provider from any claims, damages, or liability arising from the services performed, except in cases of gross negligence.</li>
                        <li><strong>Payment:</strong> Customer agrees to pay for services rendered as quoted or invoiced.</li>
                    </ul>
                </div>
                
                <div class="waiver-text">
                    <h3>ACKNOWLEDGMENT</h3>
                    <p>I, <strong>${customerName}</strong>, have read and understand this liability waiver. I agree to its terms and acknowledge that I am signing this document voluntarily.</p>
                </div>
                
                <div class="signature-display">
                    <div class="signature-row">
                        <div>
                            <div class="signature-line">
                                <img src="${signatureImg}" alt="Customer Signature">
                            </div>
                            <span>Customer Signature</span>
                        </div>
                        <div>
                            <div class="date-line">${formattedDate}</div>
                            <span>Date</span>
                        </div>
                    </div>
                    <p style="font-size: 10px; color: #666; margin-top: 15px; text-align: center;">
                        Document generated on ${new Date().toLocaleString()}
                    </p>
                </div>
                
                <div class="share-buttons">
                    <button class="share-btn download" onclick="window.print()">
                        <i class="fas fa-print"></i> Print / Save PDF
                    </button>
                </div>
            `;
            
            // Show save button if we have a job ID
            if (jobId) {
                document.getElementById('saveBtn').style.display = 'block';
            }
        }
        
        async function saveToJob() {
            if (!jobId) {
                alert('No job associated with this waiver');
                return;
            }
            
            const preview = document.getElementById('waiverPreview');
            
            try {
                // Generate image of the waiver
                const canvas = await html2canvas(preview, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const pdfDataUrl = canvas.toDataURL('image/png');
                
                // Get waiver data
                const waiverData = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    customerName: document.getElementById('customerName').value,
                    customerAddress: document.getElementById('customerAddress').value,
                    serviceDescription: document.getElementById('serviceDescription').value,
                    waiverDate: document.getElementById('waiverDate').value,
                    signature: getSignatureImage(),
                    pdfDataUrl: pdfDataUrl
                };
                
                // Save to job
                const jobs = PPW_DATA.getJobs();
                const job = jobs.find(j => j.id === jobId);
                
                if (job) {
                    if (!job.documents) {
                        job.documents = { estimates: [], invoices: [], waivers: [] };
                    }
                    if (!job.documents.waivers) {
                        job.documents.waivers = [];
                    }
                    job.documents.waivers.push(waiverData);
                    PPW_DATA.updateJob(job);
                    
                    alert('Waiver saved to job!');
                    window.location.href = `jobs.html`;
                } else {
                    alert('Job not found');
                }
            } catch (err) {
                console.error('Error saving waiver:', err);
                alert('Error saving waiver. Please try again.');
            }
        }
        
        // Pre-fill from job if we have one
        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            
            // Set today's date
            document.getElementById('waiverDate').value = new Date().toISOString().split('T')[0];
            
            if (jobId) {
                const jobs = PPW_DATA.getJobs();
                currentJob = jobs.find(j => j.id === jobId);
                
                if (currentJob) {
                    document.getElementById('customerName').value = currentJob.customerName || '';
                    document.getElementById('customerAddress').value = currentJob.address || '';
                    document.getElementById('customerPhone').value = currentJob.customerPhone || '';
                    document.getElementById('serviceDescription').value = currentJob.serviceType || '';
                }
            }
            
            setActiveNav();
        });
        
        // Resize canvas on window resize
        window.addEventListener('resize', () => {
            const imgData = canvas.toDataURL();
            initCanvas();
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = imgData;
        });
    </script>
</body>
</html>
